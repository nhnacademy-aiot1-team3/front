<!DOCTYPE html>
<html lang="ko" dir="ltr" data-bs-theme="light" data-color-theme="Blue_Theme"
      data-layout="vertical" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/owner_layout}" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- jQuery ë¨¼ì € ë¡œë“œ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" defer></script>
    <!-- ê·¸ ë‹¤ìŒ jQuery UI ë¡œë“œ -->
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js" defer></script>
    <!-- jQuery UI CSS ë¡œë“œ -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/smoothness/jquery-ui.css">
    <style>
        table, th, td { border:1px solid #000000;width:650px;border-collapse:collapse;padding:5px;text-align:center; }
        .selected { background-color:#FFFFDF; }
        .sortable-table tbody {
            cursor: move;
        }
    </style>
    <script defer>
        $(document).ready(function() {
            $("#sortable-tbody").sortable({
                update: function(event, ui) {
                }
            });
        });
    </script>
    <script th:inline="javascript">
        let g = [[${organizationList}]];
        console.log(g);
        let m = [[${mainConfigurationList}]]
        console.log("main List : ",m);
        let removeConfigList = [];
        const thisUrl = "https://databo3.live/owner/mainConfigurations";
    </script>
    <script defer>
        let dataList = null;
        let typeSensors = null;
        const chartTypesMap = new Map();
        chartTypesMap.set('REAL_TIME', 'ì‹¤ì‹œê°„');
        chartTypesMap.set('ONE_HOUR', 'í•œì‹œê°„');
        chartTypesMap.set('DAILY', 'ì¼ ë³„');
        chartTypesMap.set('WEEKLY', 'ì£¼ ë³„');

        //ì„ íƒí•œ ì¡°ì§ span íƒœê·¸ì— í‘œì‹œ, ì„ íƒí•œ ì¡°ì§ì— ì†í•œ ì •ë³´ë“¤ ë¹„ë™ê¸° ìš”ì²­
        function printSelectedOrganization() {
            // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let selectElement = document.getElementById('organizationSelect');
            // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
            // span ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let spanElement = document.getElementById('selectedOrganization');
            spanElement.textContent = selectedOptionText;

            // ì„ íƒí•œ ì¡°ì§ì˜ ì •ë³´ë“¤ ìš”ì²­
            fetchToSensorTypeMapping(selectElement.options[selectElement.selectedIndex].value);
        }
        //ì„ íƒí•œ ì¥ì†Œ span íƒœê·¸ì— í‘œì‹œ, type Row ì•ˆì— ë‚´ìš© ë§Œë“¤ê³  show
        function printSelectedPlace() {
            // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let selectElement = document.getElementById('placeSelect');
            // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
            // span ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let spanElement = document.getElementById('selectedPlace');
            spanElement.textContent = selectedOptionText;

            // type Row ë³´ì—¬ì£¼ê¸°
            // 1. ì¤‘ë³µ ì œê±°ëœ type ë¦¬ìŠ¤íŠ¸ ìƒì„± <- ì´ ë¦¬ìŠ¤íŠ¸ê°€ ì•„ë‹ˆë¼ ì„ íƒí•œ ì¥ì†Œì—ì„œì˜ ì¤‘ë³µë˜ì§€ ì•Šì€ ì„¼ì„œ íƒ€ì… ëª©ë¡ë“¤
            // ì„ íƒí•œ ì¥ì†Œì— í•´ë‹¹í•˜ëŠ” ì„¼ì„œ íƒ€ì… ëª©ë¡ì„ í•„í„°ë§
            const placeFilteredData = dataList.filter(item => item.placeName === selectedOptionText);
            // ì¤‘ë³µ ì œê±°ëœ ì„¼ì„œ íƒ€ì… ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const uniqueType = [...new Set(placeFilteredData.map(item => item.sensorType))];
            console.log("íƒ€ì… : ", uniqueType);

            // 2. type ë¦¬ìŠ¤íŠ¸ë¥¼ typeSelect ìš”ì†Œì— ì˜µì…˜ ì¶”ê°€
            const typeSelect = document.getElementById('typeSelect');
            typeSelect.innerHTML = '<option value="">íƒ€ì…ì„ ê³¨ë¼ì£¼ì„¸ìš”</option>';
            uniqueType.forEach(sensorType => {
               const option = document.createElement('option');
               option.value = sensorType;
               option.textContent = sensorType;
               typeSelect.appendChild(option);
            });

            // 3. typeRow display none -> block;
            document.getElementById('typeRow').style.display = 'block';
        }

        // ì„ íƒí•œ Type span íƒœê·¸ì— í‘œì‹œ, í•´ë‹¹ typeì— ì†í•˜ëŠ” ì„¼ì„œ ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ì–´ì„œ Row ë³´ì—¬ì£¼ê¸°
        function printSelectedType() {
            // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let selectElement = document.getElementById('typeSelect');
            // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
            // span ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let spanElement = document.getElementById('selectedType');
            spanElement.textContent = selectedOptionText;

            // ì„ íƒí–ˆë˜ ì¥ì†Œ ê°€ì ¸ì˜¤ê¸° -> sensor ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ ë•Œ filter ìš©ë„ -> place, type
            let placeSelectElement = document.getElementById('placeSelect');
            // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let placeSelectedOptionText = placeSelectElement.options[placeSelectElement.selectedIndex].text;

            // ì„¼ì„œ row ë³´ì—¬ì£¼ê¸°
            // type sensorSn ë¦¬ìŠ¤íŠ¸ ìƒì„±
            const placeAndTypeFilterData = dataList.filter(item => item.placeName === placeSelectedOptionText).filter(item => item.sensorType === selectedOptionText);
            const uniqueSensors = [...new Set(placeAndTypeFilterData.map(item => item.sensorSn))];
            console.log("ì„¼ì„œ ëª©ë¡ : ", uniqueSensors)

            // select ìš”ì†Œì— ì˜µì…˜ ì¶”ê°€
            const sensorSelect = document.getElementById('sensorSelect');
            sensorSelect.innerHTML = '<option value="">ì„¼ì„œë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</option>'; // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
            uniqueSensors.forEach(sensorSn => {
                const option = document.createElement('option');
                option.value = sensorSn;
                option.textContent = sensorSn;
                sensorSelect.appendChild(option);
            });

            // sensor row ë³´ì—¬ì£¼ê¸°
            document.getElementById('sensorRow').style.display = 'block';
        }

        //ì„ íƒí•œ ì„¼ì„œ span íƒœê·¸ì— í‘œì‹œ, chartType ë¦¬ìŠ¤íŠ¸ë¡œ ë“œë¡­ë°•ìŠ¤ ê·¸ë ¤ì£¼ê¸°
        function printSelectedSensor() {
            // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let selectElement = document.getElementById('sensorSelect');
            // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
            // span ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let spanElement = document.getElementById('selectedSensor');
            spanElement.textContent = selectedOptionText;

            // chartType ë“œë¡­ë°•ìŠ¤ ê·¸ë ¤ì£¼ê¸°
            const chartTypeSelect = document.getElementById('chartTypeSelect');
            chartTypeSelect.innerHTML = '<option value="">ì°¨íŠ¸ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</option>'; // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
            chartTypesMap.forEach((value, key) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value;
                chartTypeSelect.appendChild(option);
            });

            // chartType row ë³´ì—¬ì£¼ê¸°
            document.getElementById('chartTypeRow').style.display = 'block';
        }

        function printSelectedChartType() {
            // select ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let selectElement = document.getElementById('chartTypeSelect');
            // ì„ íƒëœ ì˜µì…˜ì˜ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
            let selectedOptionText = selectElement.options[selectElement.selectedIndex].value;
            console.log('ì„ íƒí•œ ì°¨íŠ¸ì˜ key : ', selectedOptionText);
            // span ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            let spanElement = document.getElementById('selectedChartType');
            spanElement.textContent = selectedOptionText;

            // hidden input ê°’ ë„£ê¸°
            console.log("ë™ì‘");

            let placeSelectElement = document.getElementById('placeSelect');
            let place = placeSelectElement.options[placeSelectElement.selectedIndex].value;
            console.log(place);

            let sensorSelectElement = document.getElementById('sensorSelect');
            let sensor = sensorSelectElement.options[sensorSelectElement.selectedIndex].value;
            console.log(sensor);

            let sensorTypeSelectElement = document.getElementById('typeSelect');
            let sensorType = sensorTypeSelectElement.options[sensorTypeSelectElement.selectedIndex].value;
            console.log(sensorType);

            let chartTypeSelectElement = document.getElementById('chartTypeSelect');
            let chartType = chartTypeSelectElement.options[chartTypeSelectElement.selectedIndex].value;
            console.log(chartType);

            let record = dataList.find(item => item.placeName === place && item.sensorSn === sensor && item.sensorType === sensorType);
            let recordNumber = record ? record.recordNumber : null;

            console.log('Record Number:', recordNumber);

            // id ê°’ ì„¤ì •
            $('#recordNumberInput').val(recordNumber);
            $('#sequenceNumberInput').val(m.length + 1);
            $('#chartTypeInput').val(chartType);


            document.getElementById('buttonRow').style.display = 'block';
        }

        function fetchToSensorTypeMapping(orgNumber) {
            const access_token = document.getElementById("access_token").value;
            console.log(orgNumber);
            const url = `https://databo3.live/api/sensor/org/` + orgNumber +`/sensorTypeMapping`;

            fetch(url,{
                headers: {
                    Authorization:access_token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ë°ì´í„°ë¥¼ ë³€í™˜í•˜ëŠ” ë¶€ë¶„
                    const transformedData = data.map(item => {
                        return {
                            recordNumber: item.recordNumber,
                            placeName: item.sensor.place.placeName,
                            sensorSn: item.sensor.sensorSn,
                            sensorName: item.sensor.sensorName,
                            sensorTypeId: item.sensorType.sensorTypeId,
                            sensorType: item.sensorType.sensorType
                        };
                    });
                    console.log(transformedData);
                    dataList = transformedData;
                    // ì¤‘ë³µ ì œê±°ëœ placeName ë¦¬ìŠ¤íŠ¸ ìƒì„±
                    const uniquePlaces = [...new Set(transformedData.map(item => item.placeName))];

                    // select ìš”ì†Œì— ì˜µì…˜ ì¶”ê°€
                    const placeSelect = document.getElementById('placeSelect');
                    placeSelect.innerHTML = '<option value="">ì¥ì†Œë¥¼ ê³¨ë¼ì£¼ì„¸ìš”</option>'; // ê¸°ë³¸ ì˜µì…˜ ì¶”ê°€
                    uniquePlaces.forEach(placeName => {
                        const option = document.createElement('option');
                        option.value = placeName;
                        option.textContent = placeName;
                        placeSelect.appendChild(option);
                    });

                    // place row ë³´ì—¬ì£¼ê¸°
                    document.getElementById('placeRow').style.display = 'block';

                    let spanElement = document.getElementById('selectedOrganization');

                })
                .catch(error => {
                    console.error('Error:', error);
                });

        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('organizationSelect').addEventListener('change',printSelectedOrganization);
            //í˜ì´ì§€ ë¡œë“œ ì‹œ place row ìˆ¨ê¸°ê¸°
            document.getElementById('placeRow').style.display='none';
            document.getElementById('placeSelect').addEventListener('change',printSelectedPlace);
            //í˜ì´ì§€ ë¡œë“œ ì‹œ type row ìˆ¨ê¸°ê¸°
            document.getElementById('typeRow').style.display='none';
            document.getElementById('typeSelect').addEventListener('change',printSelectedType);
            //í˜ì´ì§€ ë¡œë“œ ì‹œ sensor row ìˆ¨ê¸°ê¸°
            document.getElementById('sensorRow').style.display='none';
            document.getElementById('sensorSelect').addEventListener('change',printSelectedSensor);
            //í˜ì´ì§€ ë¡œë“œ ì‹œ chartType row ìˆ¨ê¸°ê¸°
            document.getElementById('chartTypeRow').style.display='none';
            document.getElementById('chartTypeSelect').addEventListener('change',printSelectedChartType);
            //í˜ì´ì§€ ë¡œë“œ ì‹œ ì¶”ê°€ button ìˆ¨ê¸°ê¸°
            document.getElementById('buttonRow').style.display='none';
        });
    </script>


    <script defer>
        function removeConfig(button) {
            let tr = button.closest('tr');
            let id = tr.getAttribute('id');

            let config = {};
            config.configId = id;

            removeConfigList.push(config);
            console.log(removeConfigList);

            // ë°©ê¸ˆ ì„ íƒí•œê±° ìˆ¨ê¸°ê¸°
            $(`#${id}`).remove();
        }

        function modifyConfig() {
            const access_token = document.getElementById("access_token").value;

            // ì‚­ì œ
            if (removeConfigList.length !== 0) {
                const url = "https://databo3.live/api/account/config/dashboard/delete";

                fetch(url, {
                    headers: {
                        Authorization: access_token,
                        'Content-Type': 'application/json'
                    },
                    method: 'POST',
                    body: JSON.stringify(removeConfigList)
                })
                    .then(response => {

                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    });
            }
            // í…Œì´ë¸” ìˆœì„œ ìˆ˜ì • í•˜ê³  redirect or get

            // ëª¨ë“  tr ìš”ì†Œ ì„ íƒ
            let trElements = document.querySelectorAll('#sortable-tbody tr');

            let i = 1;
            let modifyList = [];

            // ê° tr ìš”ì†Œì˜ id ê°’ì„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
            trElements.forEach(tr => {
                let obj = {};
                obj.configId = tr.id;
                obj.sequenceNumber = i++;
                modifyList.push(obj)
            });

            // ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
            console.log(modifyList);

            const modifyUrl = "https://databo3.live/api/account/config/dashboard/modify"

            fetch(modifyUrl,{
                headers: {
                    Authorization: access_token,
                    'Content-Type': 'application/json'
                },
                method: 'POST',
                body: JSON.stringify(modifyList)
            })
                .then(response => {
                })
                .catch(error => {
                    console.error('ì‚­ì œ fetch:', error);
                });

            location.replace(thisUrl);

        }

    </script>
</head>
<th:block layout:fragment="content">
    <body>
    <input type="hidden" id="access_token" th:value="${get_access_token}"/>
        <div class="body-wrapper">
            <div class="container-fluid">
                <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4">
                    <div class="card-body px-4 py-3">
                        <div class="row">
                            <!-- ì¡°ì§ ë“œë¡­ë°•ìŠ¤ -->
                            <div class="col-6">
                                <select id="organizationSelect" th:field="*{organizationList}" class="form-check">
                                    <option value="">ì¡°ì§ì„ ê³¨ë¼ì£¼ì„¸ìš”</option>

                                    <option th:if="${organization.getState() == 2}" th:each="organization:${organizationList}" th:value="${organization.getOrganizationId()}"
                                            th:text="${organization.getOrganizationName()}"></option>
                                </select>
                            </div>
                            <!-- ì¡°ì§ ë“œë¡­ë°•ìŠ¤ì—ì„œ ì„ íƒí•œê±° ë³´ì´ê¸° -->
                            <div class="col-6">
                                ğŸ—‚ï¸ ì„ íƒëœ ì¡°ì§ : <span id="selectedOrganization"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4" id="placeRow">
                    <div class="card-body px-4 py-3">
                        <div class="row">
                            <!-- ì¥ì†Œ ë“œë¡­ë°•ìŠ¤ -->
                            <div class="col-6">
                                <select id="placeSelect">

                                </select>
                            </div>
                            <!-- ì¥ì†Œ ë“œë¡­ë°•ìŠ¤ì—ì„œ ì„ íƒí•œê±° ë³´ì´ê¸° -->
                            <div class="col-6">
                                ğŸšª ì„ íƒëœ ì¥ì†Œ : <span id="selectedPlace"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <!-- íƒ€ì… ë¨¼ì € -->
                <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4" id="typeRow">
                    <div class="card-body px-4 py-3">
                        <div class="row">
                            <!-- íƒ€ì… ë“œë¡­ë°•ìŠ¤ -->
                            <div class="col-6">
                                <select id="typeSelect">

                                </select>
                            </div>
                            <!-- íƒ€ì… ë“œë¡­ë°•ìŠ¤ì—ì„œ ì„ íƒí•œê±° ë³´ì´ê¸° -->
                            <div class="col-6">
                                ğŸ”¥ ì„ íƒëœ íƒ€ì… : <span id="selectedType"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4" id="sensorRow">
                    <div class="card-body px-4 py-3">
                        <div class="row">
                            <!-- ì„¼ì„œ ë“œë¡­ë°•ìŠ¤ -->
                            <div class="col-6">
                                <select id="sensorSelect">

                                </select>
                            </div>
                            <!-- ì„¼ì„œ ë“œë¡­ë°•ìŠ¤ì—ì„œ ì„ íƒí•œ ê±° ë³´ì´ê¸° -->
                            <div class="col-6">
                                ğŸš¨ ì„ íƒëœ ì„¼ì„œ : <span id="selectedSensor"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4" id="chartTypeRow">
                    <div class="card-body px-4 py-3">
                        <div class="row">
                            <!-- ì°¨íŠ¸íƒ€ì… ë“œë¡­ë°•ìŠ¤ -->
                            <div class="col-6">
                                <select id="chartTypeSelect">

                                </select>
                            </div>
                            <!-- ì°¨íŠ¸íƒ€ì… ë“œë¡­ë°•ìŠ¤ì—ì„œ ì„ íƒí•œ ê±° ë³´ì´ê¸° -->
                            <div class="col-6">
                                ğŸ“Š ì„ íƒëœ ì°¨íŠ¸ : <span id="selectedChartType"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-5">

                </div>
                <div class="card bg-info-subtle shadow-none position-relative overflow-hidden mb-4" id="buttonRow">
                    <div class="card-body px-4 py-3">
                        <div class="row" style="display: flex; justify-content: center">
                            <form action=/owner/mainConfigurations method="post">
                                <input type="hidden" id="recordNumberInput" name="recordNumber">
                                <input type="hidden" id="sequenceNumberInput" name="sequenceNumber">
                                <input type="hidden" id="chartTypeInput" name="chartType">
                                <button type="submit" class="btn-primary">ì¶”ê°€</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <div class="row mt-5">
                    <!-- ë„ì–´ì“°ê¸° ìš© -->
                </div>
                <h1>ì €ì¥í•œ Main ì„¤ì •</h1>
                <table class="sortable-table" style="width:100%">
                    <thead>
                        <tr>
                            <th>ë“±ë¡ëœ ìˆœì„œ</th>
                            <th>ì¡°ì§</th>
                            <th>ì¥ì†Œ</th>
                            <th>ì„¼ì„œ ( íƒ€ì… )</th>
                            <th>ì°¨íŠ¸ ì¢…ë¥˜</th>
                            <th>ì‚­ì œí•˜ê¸°</th>
                        </tr>
                    </thead>
                    <tbody id="sortable-tbody">
                        <tr th:id="${config.getConfigId()}" th:each="config, status : ${mainConfigurationList}">
                            <td th:text="${config.getSequenceNumber()}" th:name="configId" th:value="${config.getConfigId()}"></td>
                            <td th:text="${config.organization}"></td>
                            <td th:text="${config.place}"></td>
                            <td>
                                <span th:text="${config.getSensorSn()}"></span> (
                                <span th:text="${config.getSensorType()}"></span> )
                            </td>
                            <td th:text="${config.getChartType()}"></td>
                            <td><button type="button" onclick="removeConfig(this)">ì‚­ì œ</button></td>
                        </tr>
                    </tbody>
                </table>
                <div class="row" style="display: flex; justify-content: right">
                    <button type="button" onclick="modifyConfig()" class="btn-primary" style="width:5%;" >ìˆ˜ì •</button>
                </div>
            </div>
        </div>
    </body>
</th:block>
</html>